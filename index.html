<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Better Buy – UPC Scanner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Barcode/QR scanner library -->
  <script src="https://unpkg.com/html5-qrcode"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 1rem;
      background: #f4f5f7;
      color: #222;
    }
    h1 {
      text-align: center;
      margin-bottom: 0.25rem;
    }
    .subtitle {
      text-align: center;
      font-size: 0.9rem;
      color: #555;
      margin-bottom: 1rem;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: #fff;
      border-radius: 10px;
      padding: 1rem 1.25rem 1.5rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    #reader {
      width: 100%;
      max-width: 500px;
      margin: 0.5rem auto 1rem;
      border-radius: 8px;
      overflow: hidden;
      background: #000;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      justify-content: center;
      margin-bottom: 0.5rem;
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 0.5rem 1rem;
      font-size: 0.9rem;
      cursor: pointer;
      background: #2563eb;
      color: #fff;
    }
    button.secondary {
      background: #6b7280;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    #scan-status {
      text-align: center;
      font-size: 0.85rem;
      margin-bottom: 1rem;
      color: #2563eb;
      min-height: 1.2em;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.5rem;
      font-size: 0.9rem;
    }
    th, td {
      border-bottom: 1px solid #e5e7eb;
      padding: 0.4rem;
      text-align: left;
      vertical-align: top;
    }
    th {
      background: #f9fafb;
      font-weight: 600;
    }
    tr.best {
      background: #dcfce7;
    }
    input[type="text"],
    input[type="number"],
    select {
      width: 100%;
      box-sizing: border-box;
      padding: 0.25rem 0.35rem;
      font-size: 0.85rem;
      border-radius: 6px;
      border: 1px solid #d1d5db;
    }
    input[readonly] {
      background: #f9fafb;
      color: #4b5563;
    }
    .footer-note {
      font-size: 0.8rem;
      color: #6b7280;
      margin-top: 0.5rem;
    }
    #result {
      margin-top: 0.75rem;
      font-weight: 600;
      font-size: 0.95rem;
    }
    .upc-breakdown {
      margin-top: 0.25rem;
      font-size: 0.7rem;
      color: #6b7280;
      display: flex;
      flex-wrap: wrap;
      gap: 0.25rem 0.5rem;
    }
    .upc-breakdown span {
      white-space: nowrap;
    }
    @media (max-width: 700px) {
      table {
        font-size: 0.8rem;
      }
      th, td {
        padding: 0.3rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Better Buy – UPC Scanner</h1>
    <div class="subtitle">
      Scan 2+ items, auto-look up SKU info, enter price, and I’ll highlight the best value.
    </div>

    <div class="controls">
      <button id="start-scan">Start Scanner</button>
      <button id="stop-scan" class="secondary" disabled>Stop Scanner</button>
      <button id="compare">Compare Items</button>
      <button id="print" class="secondary">Print</button>
    </div>

    <div id="scan-status"></div>
    <div id="reader"></div>

    <table id="items-table">
      <thead>
        <tr>
          <th>#</th>
          <th>UPC & Breakdown</th>
          <th>Description</th>
          <th>Size</th>
          <th>Unit</th>
          <th>Price ($)</th>
          <th>Unit Price</th>
        </tr>
      </thead>
      <tbody>
        <!-- rows added here -->
      </tbody>
    </table>

    <div id="result"></div>

    <div class="footer-note">
      UPC-A: <b>1</b> digit number system, <b>5</b> digits manufacturer, <b>5</b> digits product code, <b>1</b> check digit.  
      Product code identifies the SKU; size comes from the product database, not from the digits themselves.
    </div>
  </div>

  <script>
    let html5QrCode = null;
    let itemCount = 0;

    const startBtn = document.getElementById("start-scan");
    const stopBtn = document.getElementById("stop-scan");
    const statusEl = document.getElementById("scan-status");
    const tableBody = document.querySelector("#items-table tbody");
    const resultEl = document.getElementById("result");

    // --- Helpers: UPC parsing -------------------------------------------------

    function normalizeUPC(raw) {
      // Strip non-digits; convert EAN-13 with leading 0 to UPC-A
      const digits = raw.replace(/\D/g, "");
      if (digits.length === 13 && digits.startsWith("0")) {
        return digits.slice(1);
      }
      return digits;
    }

    function parseUPC(upc) {
      const digits = normalizeUPC(upc);
      if (digits.length !== 12) {
        return {
          raw: digits,
          numberSystem: null,
          manufacturer: null,
          product: null,
          checkDigit: null
        };
      }
      return {
        raw: digits,
        numberSystem: digits[0],
        manufacturer: digits.slice(1, 6),
        product: digits.slice(6, 11),
        checkDigit: digits[11]
      };
    }

    // --- Helpers: Try to parse quantity like "500 ml" or "16.9 fl oz" --------

    function parseQuantity(quantityStr) {
      if (!quantityStr) return null;

      // Common forms: "500 ml", "16.9 fl oz", "1 L", "12 oz", "24 x 500 ml" etc.
      // We’ll grab the first number and unit-ish token that follows.
      const match = quantityStr.match(/(\d+(?:[\.,]\d+)?)\s*([a-zA-Z]+(?:\s*[a-zA-Z]+)?)/);
      if (!match) return null;

      let value = parseFloat(match[1].replace(",", "."));
      let unit = match[2].trim().toLowerCase();

      // Normalize some unit names to something consistent with our dropdown
      if (unit === "ml" || unit === "milliliter" || unit === "milliliters") {
        unit = "mL";
      } else if (unit === "l" || unit === "liter" || unit === "liters") {
        unit = "L";
      } else if (unit === "g" || unit === "gram" || unit === "grams") {
        unit = "g";
      } else if (unit === "kg" || unit === "kilogram" || unit === "kilograms") {
        unit = "kg";
      } else if (unit === "oz" || unit === "ounce" || unit === "ounces") {
        unit = "oz";
      } else if (unit === "fl" || unit === "floz" || unit === "fl.oz" || unit === "fl oz") {
        unit = "fl oz";
      } else if (unit.includes("fl") && unit.includes("oz")) {
        unit = "fl oz";
      } else if (unit === "count" || unit === "ct") {
        unit = "count";
      }

      return { value, unit };
    }

    // --- API lookup: OpenFoodFacts (no key needed for many grocery items) -----

    async function lookupUPCWithAPI(upc, row) {
      try {
        const url = `https://world.openfoodfacts.org/api/v0/product/${upc}.json`;
        const res = await fetch(url);
        if (!res.ok) {
          console.warn("Lookup failed:", res.status);
          return;
        }
        const data = await res.json();
        if (data.status !== 1 || !data.product) {
          console.warn("Product not found for UPC", upc);
          return;
        }

        const product = data.product;

        // Fill description
        const descInput = row.querySelector("td:nth-child(3) input");
        const existingDesc = descInput.value.trim();
        const name =
          product.product_name ||
          product.generic_name ||
          product.brands ||
          "";
        if (!existingDesc && name) {
          descInput.value = name;
        }

        // Try to parse quantity into size + unit
        const qty = product.quantity || product.serving_size || "";
        const parsedQty = parseQuantity(qty);
        if (parsedQty) {
          const sizeInput = row.querySelector(".size-input");
          const unitSelect = row.querySelector(".unit-select");
          if (!sizeInput.value) sizeInput.value = parsedQty.value;
          // Only override unit if it’s still the default
          if (unitSelect.value === "fl oz" || !unitSelect.value) {
            // If parsed unit is one of our options, use it
            const options = Array.from(unitSelect.options).map(o => o.value);
            if (options.includes(parsedQty.unit)) {
              unitSelect.value = parsedQty.unit;
            }
          }
        }

      } catch (err) {
        console.error("Error during UPC lookup", err);
      }
    }

    // --- Row creation ---------------------------------------------------------

    function addItem(upcRaw) {
      const upcNorm = normalizeUPC(upcRaw);
      const parsed = parseUPC(upcNorm);

      itemCount++;
      const row = document.createElement("tr");

      row.innerHTML = `
        <td>${itemCount}</td>
        <td>
          <div><input type="text" value="${parsed.raw || upcNorm}" readonly /></div>
          <div class="upc-breakdown">
            <span>NS: ${parsed.numberSystem ?? "?"}</span>
            <span>Mfr: ${parsed.manufacturer ?? "?"}</span>
            <span>Prod: ${parsed.product ?? "?"}</span>
            <span>Chk: ${parsed.checkDigit ?? "?"}</span>
          </div>
        </td>
        <td><input type="text" placeholder="Optional name" /></td>
        <td><input type="number" min="0" step="0.01" class="size-input" placeholder="e.g. 16.9" /></td>
        <td>
          <select class="unit-select">
            <option value="fl oz">fl oz</option>
            <option value="oz">oz</option>
            <option value="lb">lb</option>
            <option value="mL">mL</option>
            <option value="L">L</option>
            <option value="g">g</option>
            <option value="kg">kg</option>
            <option value="count">count</option>
          </select>
        </td>
        <td><input type="number" min="0" step="0.01" class="price-input" placeholder="e.g. 0.25" /></td>
        <td class="unit-price-cell">—</td>
      `;

      tableBody.appendChild(row);

      // Live lookup of SKU info (description, size, unit)
      lookupUPCWithAPI(parsed.raw || upcNorm, row);

      const sizeInput = row.querySelector(".size-input");
      const priceInput = row.querySelector(".price-input");

      function recalc() {
        const size = parseFloat(sizeInput.value);
        const price = parseFloat(priceInput.value);
        const cell = row.querySelector(".unit-price-cell");

        if (size > 0 && price > 0) {
          const unitPrice = price / size;
          row.dataset.unitPrice = unitPrice;
          cell.textContent = "$" + unitPrice.toFixed(4);
        } else {
          row.dataset.unitPrice = "";
          cell.textContent = "—";
        }
      }

      sizeInput.addEventListener("input", recalc);
      priceInput.addEventListener("input", recalc);
    }

    // --- Scanner callbacks ----------------------------------------------------

    function onScanSuccess(decodedText, decodedResult) {
      const upcNorm = normalizeUPC(decodedText);

      // Avoid rapid duplicate scans of the same code
      const lastUPC = tableBody.lastElementChild?.querySelector("td:nth-child(2) input")?.value;
      if (upcNorm === lastUPC) return;

      addItem(upcNorm);
      const parsed = parseUPC(upcNorm);
      statusEl.textContent =
        "Scanned UPC: " +
        (parsed.raw || upcNorm) +
        (parsed.product ? " (Product Code: " + parsed.product + ")" : "");
    }

    function onScanFailure(error) {
      // Keep UI quiet to avoid spam; log if needed
      // console.log(error);
    }

    // --- Scanner controls -----------------------------------------------------

    async function startScanner() {
      try {
        if (!html5QrCode) {
          html5QrCode = new Html5Qrcode("reader");
        }

        await html5QrCode.start(
          { facingMode: "environment" },
          {
            fps: 10,
            qrbox: 250,
            formatsToSupport: [
              Html5QrcodeSupportedFormats.UPC_A,
              Html5QrcodeSupportedFormats.UPC_E,
              Html5QrcodeSupportedFormats.EAN_13,
              Html5QrcodeSupportedFormats.CODE_128
            ]
          },
          onScanSuccess,
          onScanFailure
        );

        startBtn.disabled = true;
        stopBtn.disabled = false;
        statusEl.textContent = "Scanner running… point the camera at a barcode.";
      } catch (err) {
        console.error(err);
        statusEl.textContent = "Error starting scanner: " + err;
      }
    }

    async function stopScanner() {
      if (html5QrCode) {
        try {
          await html5QrCode.stop();
          statusEl.textContent = "Scanner stopped.";
        } catch (err) {
          console.error(err);
          statusEl.textContent = "Error stopping scanner: " + err;
        }
      }
      startBtn.disabled = false;
      stopBtn.disabled = true;
    }

    // --- Comparison logic -----------------------------------------------------

    function compareItems() {
      const rows = Array.from(tableBody.querySelectorAll("tr"));
      rows.forEach(r => r.classList.remove("best"));
      resultEl.textContent = "";

      let bestRow = null;
      let bestPrice = Infinity;

      rows.forEach(row => {
        const value = parseFloat(row.dataset.unitPrice);
        if (!isNaN(value) && value > 0 && value < bestPrice) {
          bestPrice = value;
          bestRow = row;
        }
      });

      if (!bestRow) {
        resultEl.textContent = "Enter size and price for at least two items to compare.";
        return;
      }

      bestRow.classList.add("best");

      const upc = bestRow.querySelector("td:nth-child(2) input").value;
      const desc = bestRow.querySelector("td:nth-child(3) input").value || "(no description)";
      const unit = bestRow.querySelector(".unit-select").value;

      resultEl.textContent =
        `Best value: ${desc} (UPC ${upc}) at $${bestPrice.toFixed(4)} per ${unit}.`;
    }

    // --- Wire up buttons ------------------------------------------------------

    document.getElementById("start-scan").addEventListener("click", startScanner);
    document.getElementById("stop-scan").addEventListener("click", stopScanner);
    document.getElementById("compare").addEventListener("click", compareItems);
    document.getElementById("print").addEventListener("click", () => window.print());
  </script>
</body>
</html>
