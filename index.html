<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Better Buy – Unit Cost Comparator</title>
  <style>
    :root {
      --bg: #f4f5f7;
      --card: #ffffff;
      --muted: #6b7280;
      --text: #111827;
      --accent: #2563eb;
      --accent-soft: #e0edff;
      --danger: #dc2626;
      --warning: #f97316;
      --ring: #d1d5db;
      --border: #e5e7eb;
    }

    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    .wrap {
      max-width: 1100px;
      margin: 0 auto;
      padding: 24px 16px;
    }

    header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      margin-bottom: 18px;
      gap: 12px;
    }

    .brand {
      font-size: 26px;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .badge {
      background: var(--accent-soft);
      border: 1px solid var(--accent);
      padding: 2px 6px;
      border-radius: 8px;
      font-size: 11px;
      color: var(--accent);
      font-weight: 600;
    }

    .controls {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      background: var(--card);
      padding: 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
    }

    select,
    input[type="text"],
    input[type="number"] {
      padding: 6px;
      border-radius: 8px;
      border: 1px solid var(--ring);
      font-size: 14px;
    }

    button {
      padding: 8px 14px;
      border-radius: 20px;
      border: 1px solid var(--ring);
      background: white;
      cursor: pointer;
    }

    button.primary {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }

    /* Shrink Item, Price, Pack, Size by 50% */
    td:nth-child(1) input,
    td:nth-child(2) input,
    td:nth-child(3) input,
    td:nth-child(4) input {
      width: 50%;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--card);
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid var(--border);
    }

    th, td {
      padding: 10px;
      border-bottom: 1px solid var(--border);
      font-size: 14px;
    }

    th {
      font-size: 11px;
      text-transform: uppercase;
      color: var(--muted);
    }

    .row-actions button {
      border: none;
      background: transparent;
      cursor: pointer;
    }

    .good {
      background: #dcfce7;
      color: #166534;
      border: 1px solid #86efac;
      border-radius: 6px;
      padding: 2px 6px;
      font-size: 12px;
    }

    .warn {
      background: #fef3c7;
      color: #92400e;
      padding: 2px 6px;
      border-radius: 8px;
      border: 1px solid #fbbf24;
    }

    footer {
      margin-top: 20px;
      font-size: 12px;
      color: var(--muted);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">Better Buy <span class="badge">Unit Cost</span></div>

      <div class="controls">
        <label>
          Compare by
          <select id="compareBy">
            <optgroup label="Weight">
              <option value="per_oz">per ounce (oz)</option>
              <option value="per_lb">per pound (lb)</option>
              <option value="per_g">per gram (g)</option>
            </optgroup>
            <optgroup label="Volume">
              <option value="per_floz">per fluid ounce (fl oz)</option>
              <option value="per_l">per liter (L)</option>
              <option value="per_ml">per milliliter (mL)</option>
            </optgroup>
            <optgroup label="Count">
              <option value="per_each">per each</option>
            </optgroup>
          </select>
        </label>

        <button id="addRow" class="primary">+ Add item</button>
        <button id="sortAsc">Sort by best</button>
        <button id="clearAll">Clear</button>
      </div>
    </header>

    <section>
      <table>
        <thead>
          <tr>
            <th>Item</th>
            <th>Price</th>
            <th>Pack</th>
            <th>Size</th>
            <th>Unit</th>
            <th>Disc %</th>
            <th>Unit Price</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>

      <div style="margin-top:8px;">
        <span id="mixWarn" class="warn" style="display:none">Mixed unit families detected</span>
      </div>
    </section>

    <footer>Made for quick in-aisle comparisons. Saves locally. No tracking.</footer>
  </div>

  <script>
    (function () {
      const FAMILIES = {
        weight: { base: "oz", map: { mg: 1/28349.523125, g: 1/28.349523125, kg: 35.27396195, oz: 1, lb: 16 }},
        volume: { base: "floz", map: { ml: 1/29.5735295625, l: 33.8140227018, floz:1, cup:8, pt:16, qt:32, gal:128 }},
        count:  { base:"each", map:{ each:1 }},
      };

      const UNIT_FAMILY = {
        mg:"weight", g:"weight", kg:"weight", oz:"weight", lb:"weight",
        ml:"volume", l:"volume", floz:"volume", cup:"volume", pt:"volume", qt:"volume", gal:"volume",
        each:"count"
      };

      const COMPARE_OPTIONS = {
        per_oz:{family:"weight", base:"oz", label:"per oz"},
        per_lb:{family:"weight", base:"lb", label:"per lb"},
        per_g:{family:"weight", base:"g", label:"per g"},
        per_floz:{family:"volume", base:"floz", label:"per fl oz"},
        per_l:{family:"volume", base:"l", label:"per L"},
        per_ml:{family:"volume", base:"ml", label:"per mL"},
        per_each:{family:"count", base:"each", label:"each"}
      };

      const tbody = document.getElementById("tbody");
      const compareBy = document.getElementById("compareBy");
      const mixWarn = document.getElementById("mixWarn");
      const STORAGE_KEY = "better-buy-v2-min";

      const state = { rows: [], idCounter: 0 };

      function esc(s) {
        return String(s).replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
      }

      function currency(n) {
        if (!isFinite(n)) return "—";
        return new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format(n);
      }

      function createRow(data={}) {
        const id = ++state.idCounter;
        const tr = document.createElement("tr");
        tr.dataset.id = id;

        tr.innerHTML = `
          <td><input type="text" value="${esc(data.name||"")}" placeholder="Item"></td>
          <td><input type="number" step="0.01" value="${esc(data.price||"")}"></td>
          <td><input type="number" step="1" value="${esc(data.pack||1)}"></td>
          <td><input type="number" step="0.01" value="${esc(data.size||"")}"></td>
          <td>
            <select>
              <optgroup label="Weight">
                <option value="mg">mg</option>
                <option value="g">g</option>
                <option value="kg">kg</option>
                <option value="oz" selected>oz</option>
                <option value="lb">lb</option>
              </optgroup>
              <optgroup label="Volume">
                <option value="ml">ml</option>
                <option value="l">l</option>
                <option value="floz">floz</option>
                <option value="cup">cup</option>
                <option value="pt">pt</option>
                <option value="qt">qt</option>
                <option value="gal">gal</option>
              </optgroup>
              <optgroup label="Count">
                <option value="each">each</option>
              </optgroup>
            </select>
          </td>
          <td><input type="number" step="0.1" value="${esc(data.disc||"")}"></td>
          <td class="uprice">—</td>
          <td class="row-actions">
            <button title="Duplicate">⎘</button>
            <button title="Delete">✕</button>
          </td>
        `;

        tbody.appendChild(tr);

        tr.querySelectorAll("input, select").forEach(el =>
          el.addEventListener("input", recalc)
        );

        tr.querySelectorAll("button")[0].onclick = () => duplicateRow(id);
        tr.querySelectorAll("button")[1].onclick = () => deleteRow(id);

        state.rows.push({ id, tr });
        recalc();
      }

      function getRowData(tr) {
        const inputs = tr.querySelectorAll("input, select");
        return {
          name: inputs[0].value,
          price: parseFloat(inputs[1].value),
          pack: parseFloat(inputs[2].value) || 1,
          size: parseFloat(inputs[3].value),
          unit: inputs[4].value,
          disc: parseFloat(inputs[5].value),
          upriceEl: tr.querySelector(".uprice"),
          tr
        };
      }

      function convertPer(perBase, fam, cmp) {
        const base = FAMILIES[fam].base;
        if (fam !== cmp.family) return perBase;

        if (fam === "weight") {
          if (cmp.base === "lb") return perBase * 16;
          if (cmp.base === "g") return perBase / 0.03527396195;
        }
        if (fam === "volume") {
          if (cmp.base === "l") return perBase / 0.0338140227;
          if (cmp.base === "ml") return (perBase / 0.0338140227) / 1000;
        }
        return perBase;
      }

      function recalc() {
        const cmp = COMPARE_OPTIONS[compareBy.value];
        const rows = state.rows.map(r => getRowData(r.tr));
        const families = new Set();

        rows.forEach(row => {
          const { price, pack, size, unit, disc } = row;
          const fam = UNIT_FAMILY[unit];
          row.family = fam;

          if (!isFinite(price) || !isFinite(size) || size <= 0) {
            row.unitPrice = NaN;
            return;
          }

          const baseConv = FAMILIES[fam].map[unit];
          const total = pack * size * baseConv;
          let eff = price;
          if (disc > 0 && disc <= 100) eff *= 1 - disc / 100;

          const perBase = eff / total;
          row.unitPrice = convertPer(perBase, fam, cmp);
          families.add(fam);
        });

        mixWarn.style.display = families.size > 1 ? "inline-block" : "none";

        const sameFamRows = rows.filter(r => r.family === cmp.family && isFinite(r.unitPrice));
        const best = sameFamRows.length ? Math.min(...sameFamRows.map(r => r.unitPrice)) : Infinity;

        rows.forEach(row => {
          const el = row.upriceEl;
          if (!isFinite(row.unitPrice)) {
            el.textContent = "—";
            return;
          }
          const isBest = Math.abs(row.unitPrice - best) < 1e-9;
          el.textContent = currency(row.unitPrice);
          el.className = "uprice" + (isBest ? " good" : "");
        });

        save();
      }

      function duplicateRow(id) {
        const r = state.rows.find(r => r.id === id);
        const d = getRowData(r.tr);
        createRow(d);
      }

      function deleteRow(id) {
        const idx = state.rows.findIndex(r => r.id === id);
        if (idx >= 0) {
          tbody.removeChild(state.rows[idx].tr);
          state.rows.splice(idx, 1);
          recalc();
        }
      }

      function save() {
        const data = {
          compareBy: compareBy.value,
          rows: state.rows.map(r => getRowData(r.tr))
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      }

      function load() {
        const data = JSON.parse(localStorage.getItem(STORAGE_KEY) || "null");
        if (!data) {
          createRow();
          createRow();
          return;
        }
        compareBy.value = data.compareBy;
        data.rows.forEach(r => createRow(r));
      }

      document.getElementById("addRow").onclick = () => createRow();
      document.getElementById("sortAsc").onclick = () => {
        const rows = Array.from(tbody.children);
        rows.sort((a,b) =>
          parseFloat(a.querySelector(".uprice").textContent.replace(/[^0-9.]/g,"")) -
          parseFloat(b.querySelector(".uprice").textContent.replace(/[^0-9.]/g,""))
        );
        rows.forEach(r => tbody.appendChild(r));
      };

      document.getElementById("clearAll").onclick = () => {
        if (confirm("Clear all rows?")) {
          tbody.innerHTML = "";
          state.rows = [];
          createRow();
          recalc();
        }
      };

      compareBy.onchange = recalc;

      load();
    })();
  </script>
</body>
</html>
